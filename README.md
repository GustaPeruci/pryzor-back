# üîß Pryzor Backend - API e Machine Learning

> **Parte do TCC de Engenharia de Software**

Aqui fica o cora√ß√£o do Pryzor: a API FastAPI que serve os dados e o modelo de Machine Learning que faz as previs√µes.

---

## ÔøΩ O que tem aqui?

Este √© o backend do projeto. Se voc√™ j√° leu o README principal, sabe que o Pryzor prev√™ descontos de jogos da Steam. Aqui √© onde a m√°gica acontece:

- üöÄ **API REST** com FastAPI (11 endpoints funcionando)
- üß† **Modelo ML v2.0** treinado com Random Forest
- üíæ **Conex√£o MySQL** com 2.000 jogos e 725k registros de pre√ßos
- ‚úÖ **Testes automatizados** para garantir que tudo funciona
- üìö **Documenta√ß√£o interativa** com Swagger

### M√©tricas do modelo:
- **Precision:** 90.46% - quando prev√™ desconto, acerta 9 em 10 vezes
- **F1-Score:** 74.34% - balan√ßo entre acertos e cobertura
- **Recall:** 63.09% - captura 63% dos descontos reais
- **Valida√ß√£o real:** 92.4% de acur√°cia em 1.000 jogos testados

**üìñ Hist√≥rico completo:** Veja `ml_model/README.md` para detalhes do modelo v2.0 e `ml_model/experiments_failed/` para an√°lise dos experimentos v2.1 e v3.0 que falharam.

---

## üìÅ Estrutura do Projeto

```
pryzor-back/
‚îú‚îÄ‚îÄ üìÇ src/                          # C√≥digo-fonte da API
‚îÇ   ‚îú‚îÄ‚îÄ main.py                      # API FastAPI (endpoints)
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ml_discount_predictor.py # Servi√ßo de predi√ß√£o ML
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schemas.py               # Schemas Pydantic
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ database/
‚îÇ       ‚îú‚îÄ‚îÄ config.py                # Configura√ß√£o MySQL
‚îÇ       ‚îî‚îÄ‚îÄ connection.py            # Gerenciamento de conex√µes
‚îÇ
‚îú‚îÄ‚îÄ üìÇ scripts/                      # Scripts de ML/ETL
‚îÇ   ‚îú‚îÄ‚îÄ 02_train_model.py            # Treinamento do modelo
‚îÇ   ‚îî‚îÄ‚îÄ README.md                    # Documenta√ß√£o dos scripts
‚îÇ
‚îú‚îÄ‚îÄ üìÇ ml_model/                     # Modelos treinados
‚îÇ   ‚îú‚îÄ‚îÄ discount_predictor.pkl       # Modelo v2.0 ATIVO (2.5 MB)
‚îÇ   ‚îú‚îÄ‚îÄ README.md                    # Documenta√ß√£o do modelo em produ√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ experiments_failed/       # Experimentos descartados (v2.1, v3.0)
‚îÇ       ‚îú‚îÄ‚îÄ discount_predictor_v2_1.pkl
‚îÇ       ‚îú‚îÄ‚îÄ 03_train_model_v2_1.py
‚îÇ       ‚îî‚îÄ‚îÄ README.md                # Por que os experimentos falharam
‚îÇ
‚îú‚îÄ‚îÄ üìÇ data/                         # Datasets
‚îÇ   ‚îî‚îÄ‚îÄ data_with_binary_target.csv  # Dataset para treinamento (679k registros)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ tests/                        # Testes automatizados
‚îÇ   ‚îî‚îÄ‚îÄ test_ml_service.py           # Testes do servi√ßo ML
‚îÇ
‚îú‚îÄ‚îÄ üìÇ docs/                         # Documenta√ß√£o do projeto
‚îÇ   ‚îú‚îÄ‚îÄ ML_MODEL.md                  # Documenta√ß√£o do modelo ML
‚îÇ   ‚îî‚îÄ‚îÄ INTEGRATION.md               # Guia de integra√ß√£o
‚îÇ
‚îú‚îÄ‚îÄ requirements.txt                 # Depend√™ncias Python
‚îú‚îÄ‚îÄ .env.example                     # Exemplo de vari√°veis de ambiente
‚îî‚îÄ‚îÄ README.md                        # Este arquivo
```

## üöÄ Rodando o Backend

### Antes de come√ßar

Voc√™ vai precisar de:
- Python 3.8 ou superior
- MySQL 8.0 rodando
- 5 minutos de paci√™ncia üòä

### Passo 1: Ambiente virtual

```bash
# Clone o projeto (se ainda n√£o fez)
cd pryzor-back

# Crie um ambiente virtual
python -m venv venv

# Ative o ambiente
venv\Scripts\activate     # Windows
source venv/bin/activate  # Mac/Linux
```

### Passo 2: Depend√™ncias

```bash
pip install -r requirements.txt
```

Isso vai instalar FastAPI, scikit-learn, pandas, MySQL connector e tudo mais que voc√™ precisa.

### Passo 3: Configure o banco

Crie um arquivo `.env` na raiz do `pryzor-back/`:

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=sua_senha_aqui
DB_NAME=steam_pryzor
```

**Dica:** Use o arquivo `.env.example` como base. S√≥ copiar e preencher com seus dados.

### Passo 4: Rodar a API

```bash
python src/main.py
```

Se tudo deu certo, voc√™ vai ver:
```
üöÄ Iniciando Pryzor API MySQL Production + ML v2.0...
‚úÖ Modelo ML v2.0 carregado com sucesso!
INFO:     Uvicorn running on http://127.0.0.1:8000
```

**Pronto!** Acesse:
- **API:** http://127.0.0.1:8000
- **Documenta√ß√£o interativa (Swagger):** http://127.0.0.1:8000/docs

---

### üóÑÔ∏è Setup do Banco de Dados (Primeira vez)

Se √© a primeira vez rodando o projeto, voc√™ precisa criar o banco e importar os dados:

#### 1. Criar banco e tabelas (em outro terminal)

```powershell
# PowerShell
Invoke-RestMethod -Uri "http://localhost:8000/api/admin/setup-database" -Method POST
```

```bash
# Bash/Linux
curl -X POST http://localhost:8000/api/admin/setup-database
```

‚úÖ Aguarde a mensagem de sucesso: "Banco de dados criado com sucesso!"

#### 2. Importar dataset completo

‚ö†Ô∏è **IMPORTANTE:** Certifique-se que os arquivos CSV est√£o na pasta `data/`:
- `data/applicationInformation.csv`
- `data/PriceHistory/*.csv` (v√°rios arquivos)

```powershell
# PowerShell
Invoke-RestMethod -Uri "http://localhost:8000/api/admin/import-dataset" -Method POST
```

```bash
# Bash/Linux
curl -X POST http://localhost:8000/api/admin/import-dataset
```

‚è≥ **Aguarde 5-10 minutos** - o processo importa ~2000 jogos e ~500k registros de pre√ßo

#### 3. Verificar se deu certo

```powershell
# Ver estat√≠sticas do banco
Invoke-RestMethod -Uri "http://localhost:8000/api/stats" -Method GET
```

Voc√™ deve ver algo como:
```json
{
  "total_games": 2002,
  "total_price_records": 500000,
  "average_price": 15.99
}
```

‚úÖ **Pronto!** O banco est√° populado e o sistema est√° pronto para uso.

---

## üì° API Endpoints (Todos os 11 endpoints)

### üè† Sistema e Health Check

#### **GET /**
**Descri√ß√£o:** Informa√ß√µes b√°sicas da API  
**Retorna:** Nome, vers√£o, links √∫teis e endpoints dispon√≠veis  
**Exemplo:** http://127.0.0.1:8000/

#### **GET /health**
**Descri√ß√£o:** Verifica se tudo est√° ok  
**Retorna:** Status da API, banco de dados e modelo ML  
**Exemplo:** http://127.0.0.1:8000/health

#### **GET /api/stats**
**Descri√ß√£o:** Estat√≠sticas gerais do sistema  
**Retorna:** Total de jogos, registros de pre√ßos, pre√ßo m√©dio, min/max  
**Exemplo:** http://127.0.0.1:8000/api/stats

---

### üéÆ Jogos (Dados)

#### **GET /api/games**
**Descri√ß√£o:** Lista jogos com pagina√ß√£o e busca  
**Par√¢metros:**
- `limit` (int) - quantos jogos retornar (padr√£o: 50)
- `offset` (int) - pagina√ß√£o (padr√£o: 0)
- `search` (string) - buscar por nome

**Exemplo:** `/api/games?search=Counter&limit=10`

#### **GET /api/games/{appid}**
**Descri√ß√£o:** Detalhes completos de um jogo espec√≠fico  
**Retorna:** Info do jogo + hist√≥rico de pre√ßos dos √∫ltimos 30 dias  
**Exemplo:** `/api/games/730` (Counter-Strike: Global Offensive)

---

### üß† Machine Learning (Previs√µes)

#### **GET /api/ml/info**
**Descri√ß√£o:** Informa√ß√µes sobre o modelo ML  
**Retorna:** Vers√£o, m√©tricas (F1, Precision, Recall), data de treino, features  
**Exemplo:** `/api/ml/info`

#### **GET /api/ml/health**
**Descri√ß√£o:** Status do servi√ßo ML  
**Retorna:** Se o modelo est√° carregado e operacional  
**Exemplo:** `/api/ml/health`

#### **GET /api/ml/predict/{appid}**
**Descri√ß√£o:** Faz previs√£o de desconto para um jogo  
**Retorna:**
- `will_have_discount` - se vai ter desconto >20%
- `probability` - probabilidade (0-1)
- `confidence` - confian√ßa na predi√ß√£o
- `recommendation` - "BUY" ou "WAIT"
- `recommendation_text` - texto explicativo
- `reasoning` - fatores que influenciaram

**Exemplo:** `/api/ml/predict/271590` (GTA V)

#### **POST /api/ml/predict/batch**
**Descri√ß√£o:** Previs√£o em lote (at√© 50 jogos)  
**Body:**
```json
{
  "appids": [730, 440, 570]
}
```
**Retorna:** Array com todas as predi√ß√µes

---

### üîß Admin (Setup e Importa√ß√£o)

#### **POST /api/admin/setup-database**
**Descri√ß√£o:** Cria banco de dados e tabelas necess√°rias  
**Retorna:** Confirma√ß√£o de cria√ß√£o com detalhes  
**Uso:** Execute este endpoint ANTES de importar dados

**PowerShell:**
```powershell
Invoke-RestMethod -Uri "http://localhost:8000/api/admin/setup-database" -Method POST
```

**Resposta de sucesso:**
```json
{
  "status": "success",
  "message": "Banco de dados criado com sucesso!",
  "details": {
    "database": "steam_pryzor",
    "tables_created": ["games", "price_history"]
  }
}
```

#### **POST /api/admin/import-dataset**
**Descri√ß√£o:** Importa CSV dataset completo para o banco  
**Requisitos:** 
- Arquivo `data/applicationInformation.csv` presente
- Pasta `data/PriceHistory/` com CSVs de pre√ßos
- Banco j√° criado com `/api/admin/setup-database`

**Retorna:** Estat√≠sticas de importa√ß√£o (jogos importados, registros de pre√ßo, etc)

**PowerShell:**
```powershell
Invoke-RestMethod -Uri "http://localhost:8000/api/admin/import-dataset" -Method POST
```

**‚ö†Ô∏è IMPORTANTE:** 
- Este processo pode levar 5-10 minutos
- Importa ~2000 jogos e ~500k registros de pre√ßo
- √â idempotente (pode executar m√∫ltiplas vezes sem duplicar dados)

**Resposta de sucesso:**
```json
{
  "status": "success",
  "message": "Dataset importado com sucesso!",
  "details": {
    "games": {
      "imported": 2002,
      "total_in_db": 2002
    },
    "price_history": {
      "files_processed": 1850,
      "records_imported": 500000,
      "total_in_db": 500000
    }
  }
}
```

---

## üß™ Testes

Quer ter certeza que tudo funciona? Rode os testes:

```bash
python tests/test_ml_service.py
```

Ele vai testar:
- ‚úÖ Se o modelo ML carrega
- ‚úÖ Se as predi√ß√µes funcionam
- ‚úÖ Se os endpoints respondem corretamente
- ‚úÖ Casos especiais (jogos free-to-play, jogos inexistentes, etc)

Se quiser testar s√≥ o modelo sem rodar a API, √© s√≥ apertar ENTER quando perguntar.

---

## üß† Sobre o Modelo de Machine Learning

### O b√°sico

- **Algoritmo:** Random Forest (100 √°rvores de decis√£o)
- **Objetivo:** Prever se um jogo vai ter desconto >20% nos pr√≥ximos 30 dias
- **Como foi treinado:** Com dados de 2019-2020, usando valida√ß√£o temporal

### Por que "valida√ß√£o temporal"?

Porque treinar um modelo de s√©ries temporais com dados embaralhados (random split) √© uma armadilha cl√°ssica. O modelo "v√™ o futuro" e as m√©tricas ficam irreais.

A gente fez certo: treinou com dados at√© 2020-04-01 e testou com dados depois dessa data. Ou seja, o modelo n√£o teve acesso aos dados do futuro durante o treino.

### M√©tricas reais

| M√©trica | Valor | O que significa na pr√°tica |
|---------|-------|----------------------------|
| **Precision** | 90.46% | Quando diz "vai ter desconto", acerta 9 em 10 vezes |
| **F1-Score** | 74.34% | Balan√ßo geral entre acertos e cobertura |
| **Recall** | 63.09% | Pega 63% de todos os descontos que realmente acontecem |
| **Accuracy** | 75.18% | Taxa geral de acerto |
| **ROC-AUC** | 79.45% | Capacidade de separar as classes |

**Por que Precision alta e Recall moderado?**  
√â uma escolha. Preferimos ser conservadores - quando dizemos "vai ter desconto", voc√™ pode confiar. O trade-off √© que perdemos alguns descontos (37% deles), mas os que pegamos s√£o confi√°veis.

### Features que o modelo usa

Todas as features s√£o baseadas em data e pre√ßo. Nada de "colar" com dados futuros:

1. **discount_percent** (28.46%) - Desconto atual do jogo
2. **month** (27.94%) - M√™s do ano (sazonalidade importa!)
3. **quarter** (19.31%) - Trimestre
4. **is_summer_sale** (7.61%) - Se est√° na Summer Sale (junho/julho)
5. **final_price** (7.25%) - Pre√ßo atual
6. **is_winter_sale** (6.72%) - Se est√° na Winter Sale (dezembro/janeiro)
7. **day_of_week** (2.32%) - Dia da semana
8. **is_weekend** (0.37%) - Se √© fim de semana

Os n√∫meros entre par√™nteses s√£o a import√¢ncia de cada feature (quanto mais alto, mais importante para o modelo).

---

## üìä Dados no Banco

- **Jogos:** 2.000 jogos da Steam
- **Registros de pre√ßo:** 725.268 linhas de hist√≥rico
- **Per√≠odo:** 2019-2020 (dados hist√≥ricos)
- **Distribui√ß√£o:** 56.98% com desconto, 43.02% sem desconto

### Por que dados de 2019-2020?

√â o dataset que t√≠nhamos dispon√≠vel. O foco do TCC √© demonstrar a **metodologia completa** (ETL, feature engineering, valida√ß√£o temporal, API, etc), n√£o necessariamente ter dados super atualizados.

Em produ√ß√£o, o pipeline seria adaptado para pegar dados atualizados da Steam API regularmente.

---

## üìÅ Estrutura das Pastas

Se voc√™ est√° navegando no c√≥digo, aqui est√° o que cada pasta faz:

```
pryzor-back/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                      # Cora√ß√£o da API (FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ml_discount_predictor.py # Servi√ßo que usa o modelo ML
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schemas.py               # Valida√ß√£o de dados (Pydantic)
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ       ‚îú‚îÄ‚îÄ config.py                # Configura√ß√µes do MySQL
‚îÇ       ‚îî‚îÄ‚îÄ connection.py            # Gerencia conex√µes com o banco
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ 02_train_model.py            # Script que treinou o modelo v2.0
‚îÇ
‚îú‚îÄ‚îÄ ml_model/
‚îÇ   ‚îî‚îÄ‚îÄ discount_predictor.pkl       # Modelo treinado (26.6 MB)
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ data_with_binary_target.csv  # Dataset usado no treino (679k linhas)
‚îÇ
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ test_ml_service.py           # Testes automatizados
```

---

## üõ†Ô∏è Tecnologias

O backend usa:

- **Python 3.11** - Linguagem base
- **FastAPI** - Framework web (ass√≠ncrono e r√°pido)
- **Uvicorn** - Servidor ASGI
- **scikit-learn** - Machine Learning (Random Forest)
- **pandas** - Manipula√ß√£o de dados
- **mysql-connector-python** - Conex√£o com MySQL
- **Pydantic** - Valida√ß√£o de dados
- **pickle** - Serializa√ß√£o do modelo

Tudo listado no `requirements.txt`.

---

## ÔøΩ Como Interpretar as Respostas da API

### Resposta de Predi√ß√£o

Quando voc√™ consulta `/api/ml/predict/{appid}`, recebe algo assim:

```json
{
  "appid": 271590,
  "game_name": "Grand Theft Auto V",
  "will_have_discount": true,
  "probability": 0.78,
  "confidence": 0.56,
  "current_discount": 0,
  "current_price": 29.99,
  "recommendation": "AGUARDAR - Alta probabilidade de desconto melhor",
  "reasoning": [],
  "model_version": "2.0"
}
```

**O que cada campo significa:**

- **will_have_discount**: `true` = modelo prev√™ desconto >20% nos pr√≥ximos 30 dias
- **probability**: 0.78 = 78% de chance (quanto maior, mais prov√°vel)
- **confidence**: 0.56 = qu√£o "seguro" o modelo est√° (dist√¢ncia de 0.5 = incerteza)
- **recommendation**: texto amig√°vel para mostrar ao usu√°rio

### Como interpretar?

**Probabilidade:**
- **> 70%** - Alta chance ‚Üí "Vale esperar"
- **50-70%** - Moderada ‚Üí "Considere esperar"
- **< 50%** - Baixa ‚Üí "Se t√° bom, compra"

**Confian√ßa:**
- **> 0.7** - Modelo muito confiante
- **0.4-0.7** - Confian√ßa moderada
- **< 0.4** - Modelo meio em d√∫vida

**Recomenda√ß√µes poss√≠veis:**
- `"AGUARDAR"` - Espera a√≠ que vem desconto
- `"CONSIDERAR AGUARDAR"` - Pode esperar, mas n√£o garanto
- `"COMPRAR AGORA"` - Desconto atual t√° √≥timo
- `"COMPRAR SE QUISER"` - Pouca chance de melhorar

### Casos especiais

**Jogo free-to-play:**
```json
{
  "will_have_discount": false,
  "probability": 0.0,
  "confidence": 1.0,
  "recommendation": "Jogo gratuito - sem necessidade de esperar"
}
```

**Jogo n√£o encontrado:**
```json
{
  "error": "Jogo n√£o encontrado",
  "appid": 999999
}
```

**Hist√≥rico insuficiente:**
```json
{
  "error": "Hist√≥rico de pre√ßos insuficiente",
  "min_required": 30,
  "found": 10
}
```

---

## üéì Para o TCC

Pontos que vale destacar na apresenta√ß√£o:

‚úÖ **Valida√ß√£o temporal correta** - Evitamos data leakage, uma armadilha comum  
‚úÖ **Pipeline completo** - ETL ‚Üí Feature Engineering ‚Üí Treino ‚Üí Valida√ß√£o ‚Üí API  
‚úÖ **C√≥digo limpo** - Estrutura organizada, coment√°rios, testes  
‚úÖ **API funcional** - 11 endpoints testados, documenta√ß√£o Swagger  
‚úÖ **Precision alta (90%)** - Sistema confi√°vel para o usu√°rio  

---

## ü§ù Contribuindo

Se voc√™ encontrar bugs ou tiver sugest√µes, fique √† vontade para:
- Abrir uma issue
- Enviar um pull request
- Entrar em contato

---

## üë§ Autor

**Gustavo Peruci**  
üéì TCC - Engenharia de Software - 2025  
üîó [GitHub](https://github.com/GustaPeruci)

---

**D√∫vidas?** Leia o README principal do projeto na raiz (`../README.md`).
